# IP地址+数据包格式+数据包分片

# 一、相关基本概念

**报文：**

应用层&传输层的数据基本单位

**数据包：**

网络层的数据基本单位

**帧：**

数链层的数据基本单位

**最大传送单元（MTU）：**

MTU既表示最大帧长（不计帧头帧尾），也表示数据包分片时的最大“片”长度。

它的值由物理介质和网络设备性能推导出来，是1500B。

> 实际上，因为使用0比特字符填充法进行组帧时会导致帧的大小发生一些膨胀，所以数据包分片时的最大“片”长度应取1420B
> 

# 二、数据包的分片与封装成帧

【定义】

当数据包的大小超过MTU时，数据包需要在网络层进行分片。

数据包分片之后，每一个“片”还是叫做一个和数据包。分片后的数据包们再来到数据链路层，被封装成帧。

# 三、**IPv4包头结构**

**【结构】**

总览中的包头分为一处“固定部分”和一处“可变部分”。

整个IPv4数据包的总长度不能超过65535字节，这是由包头中的“总长度”字段的位数决定的。

**【固定部分】**

各字段如下：

![Untitled](IP%E5%9C%B0%E5%9D%80+%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F+%E6%95%B0%E6%8D%AE%E5%8C%85%E5%88%86%E7%89%87%20358f2280744a4ead9baa5851bc63276a/Untitled.png)

- **版本**：表示IP协议的版本号，IPv4为4。
- **头部长度**：表示“可变部分+不可变部分”的长度，以4B为单位。因此，实际的IPv4头部长度是该字段值乘以4字节。
- **服务类型**：用于指定数据包的服务质量和优先级。包括前6位的DSCP（Differentiated Services Code Point）和后2位的ECN（Explicit Congestion Notification）字段。
- **总长度**：表示整个IPv4数据包的长度，以字节为单位，最大长度为65535字节。
- **标识**（Identification）：在分片时，相同数据包的不同片段共享相同的标识。
- **标志**（Flag）：3位。包括DF（Don't Fragment）、MF（More Fragments）和保留位。
    - 中间位MF：1=我后面还有分片，0=我是最后一个分片辣（M表示“more”）
    - 最低位DF：1=禁止分片，0=允许分片（D表示“don't”）
- **片偏移：** 13位。指示分片在原始数据包中的位置，以8字节为单位。
    
    > 所以除了最后一个片其他片都会向8B对齐
    > 
- **生存时间（TTL）**：即Time2Live，表示数据包在网络中能生存多少跳，每经过一个路由器TTL减1，为0时数据包被丢弃。
- **协议：**指示数据部分使用的协议，例如TCP、UDP、ICMP等。每种协议都有一个对应的协议号。
    
    各个协议对应的协议号如下：
    
    | TCP | UDP | ICMP | IGMP | EGP | IGP | IPv6 | ESP | OSPF |
    | --- | --- | --- | --- | --- | --- | --- | --- | --- |
    | 6 | 17 | 1 | 2 | 8 | 9 | 41 | 50 | 89 |
- **头部校验和：**检测IPv4头部在传输过程中是否发生错误。
- **源地址&目的地址**：ip地址

# 四、IPv4地址格式

【定义】

IPv4地址是一个4B的标识符，我们将其分成四块，每块表示为1B的unsigned整数。每块用“点分的十进制表示法”表示为0~255。

根据ABC地址分类&子网掩码，可以将其分为前后两部分：前面是网络号，后面是主机号。网络号不能重复，同个网络号里的主机号不能重复。

其中网络号的意义是进行路由选择以寻找到目标所在子网，主机号的意义是在目标子网的ARP协议中解析成mac地址。

【特殊的IP地址】

公网IP地址中的这些地址值被保留不用以表示特殊含义：

- **`主机号全1`**：表示向某子网中的所有主机广播。
- **`127.0.0.0 到 127.255.255.255`**：表示本地回环地址
- **`255.255.255.255`**：名为“有限广播地址”，用于在当前子网中向所有主机广播。
- `0.0.0.0`：用于在服务器的接收端表示“任何”
- **`ABC三类私有ip地址`**：参考同章节下的“路由选择与分组转发规则”笔记

<aside>
💡 记“有限广播地址”这一名词。

</aside>

# 五、IPv6包头

【定义】

相比于IPv4，其升级版IPv6的包头提供了更多参数选项。同时该协议拓展了其可用的IP地址范围。

【包总体结构】

其总体结构如下：

![Untitled](IP%E5%9C%B0%E5%9D%80+%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F+%E6%95%B0%E6%8D%AE%E5%8C%85%E5%88%86%E7%89%87%20358f2280744a4ead9baa5851bc63276a/Untitled%201.png)

> 其中，这种在body中分出一些空间来存放首部拓展信息的设计，可以方便未来对IPv6协议进行扩充。
> 

【包头结构】

包头结构如下：

![Untitled](IP%E5%9C%B0%E5%9D%80+%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F+%E6%95%B0%E6%8D%AE%E5%8C%85%E5%88%86%E7%89%87%20358f2280744a4ead9baa5851bc63276a/Untitled%202.png)

与IPv4重复的内容就不做介绍了，下面介绍一些不同的点

- “下一个首部”字段指向下一个拓展首部，形成类似链表的结构，可以无限链入扩展首部。
- 省去了“校验和”，因为现代的数链层已经可以向上层保证传输的数据报百分百地不发生比特错误。

【通信方式】

- 单播：一对一
- 多播（组播）：一对多台主机进行广播。也叫组播，即把多台主机看成“一组”，然后对这一组中的每一台主机发包
- 任播：对一组中的任意一个（一般是距离最近的一个）发包（然后由收到包的那个去同步数据给其他主机即可）

【IPv4到IPv6过渡策略】

- 双栈协议：同一台主机上既安装ipv4协议栈又安装ipv6协议栈
- 隧道技术：将ipv6数据报封装到ipv4的数据部分，以ipv4的形式传送（暗度陈仓~）

# 六、IPv6地址格式

【定义】

共16字节，以两个字节一组，分得8组。每组之间用冒号隔开，得到其基础记法，例如：

`4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170`

如果地址中有连续的几组是全0，则可以把这几组省略为一对冒号，例如：

`4BF5:0000:0000:0000:BA5F:039A:BE9A:2170`$\xRightarrow{可以记为}$`4BF5::BA5F:039A:BE9A:2170`