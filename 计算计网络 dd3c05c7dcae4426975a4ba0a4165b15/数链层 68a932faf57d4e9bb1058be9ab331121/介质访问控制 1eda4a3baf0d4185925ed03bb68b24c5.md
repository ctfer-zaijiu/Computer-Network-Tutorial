# 介质访问控制

# 一、相关基本概念

**冲突：**

一条介质里面如果有多个不同节点同时在发信号，这些信号之间会造成互相干扰，这就叫做“冲突”。

**介质访问控制：**

也叫“多路访问协议”

通过对广播信道的流量按照一定规则进行分配，可以实现尽量避免和处理冲突，保证多个不同节点在同时发信号情况下的通信正常，这就是“介质访问控制”。

介质访问控制的意义在于：

所有通信介质在物理上看都是半双工的，但是通过介质访问控制不仅可以将它们虚拟化地视为全双工的，还可以虚拟地视为当多个节点共用一条信道时是可以随意互通的。

**介质访问控制协议分类：**

按照介质访问控制协议的风格，可以分为以下三类协议：

- 静态划分信道：在信息发送前就将信道按照频率等因素分为多份，这样可以100%避免冲突的发生，但缺点是效率低下。
- 动态划分信道：在发送消息的过程中，每个设备可以占用完整的整条信道，然后通过冲突信息不断调整信道分配以使冲突更少发生。其优点是效率较高，缺点是在网络负载较大的情况下由于冲突频发会导致效率被影响。
- 令牌轮询：由“大哥”挨个问各个节点谁需要发信息。其特点是各节点不能随意发送信息而是需要服从“大哥”调度。其既避免了静态划分信道时用户不能使用整个带宽，也100%避免了冲突，但缺点是令牌轮询过程本身会导致额外的开销。

**信道：**

一条链路，通过介质访问控制，可以被划分为多条信道

**同频率下正交信号互不干扰：**

两个信号的波形相互垂直，为正交

当多路信号之间满足正交性时，即使是在同一频率下也可以实现互不干扰

**“隐蔽站”问题：**

这是一个CSMA/CA协议考虑的问题。如下图：

![Untitled](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled.png)

因为无线监听信道的技术实现是基于“能量检测”和“载波检测”，而这会被墙体阻拦。这就会导致A节点在进行“先听后发”时不能发现C是否正在占用信道，就可能会导致以下情况：

C在发送信息时，A正好也想要发送信息，但是由于A不知道C此时正在发送信息，所以此时也进行了发送信息，这就导致了A、C发生冲突。

# 二、静态划分信道

其基于如下的设备基本模型：

![Untitled](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled%201.png)

有如下几种具体方案：

- **1、频分多路复用**
  
    【定义】
    
    就是把带宽分成不同的频率，每个频率对应一个信道，如图：
    
    ![Untitled](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled%202.png)
    
    然后为了防止信道之间的干扰，信道之间需要加入“保护频道”，也就是两段频率区间之间隔处一个小频率区间不表示任何含义。
    
    【特点】
    
    特点是技术比较成熟，实现起来也较为容易。“共享时间但不共享空间”
    
    【拓展】
    
    **波分多路复用**：
    
    光纤传输的时候，按照波长分出很多个信道频道
    
    > 实际上可以当做“光的频分复用”，因为波长就是频率
    > 
- **2、时分多路复用**
  
    【定义】
    
    ![Untitled](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled%203.png)
    
    类似于cpu分时间片原理，只要每个时间片够小，就像是并发进行的一般
    
    并且可以直接应用类似于CPU进程调度的机制，实现按需分配时间片资源
    
    【特点】
    
    “共享空间但不共享时间”
    
    【分类】
    
    可以分为以下两种：
    
    - **同步时分复用：**
      
        首先，该机制基于所有发送端必须具有相同的时钟，这需要采用精密的时钟同步机制。
        
        然后，我们把一秒的时间划分为固定的几个时隙，每一个时隙绑定一个。在A时隙里只允许A发送消息，在B时隙里只允许B发送消息。
        
        其特点是因为时隙可以作为身份标志，所以数据包头可以不用标明发送端身份。
        
    - **异步时分复用：**
      
        基于需要，系统为各个发送端动态地分配其可以使用哪些时间片。
        
        每个发送端可以有自己的时钟，关于时间的控制只需要在接收端进行同步。
        
    
    <aside>
    ⚠️ 背！
    
    </aside>
    
- **3、码分多路复用（!!!）**
  
    【定义】
    
    通过将多路信号之间传输前做正交叠加，传输后做规格化内积分解，就可以实现同时传输时的互不干扰。
    
    具有“共享时间又共享空间”的特点，是目前移动通信使用的技术。
    
    【操作】
    
    > 这里以“A、B同时向C发送信息”的情境为例：
    > 
    > 
    > ![Untitled](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled%204.png)
    > 
    
    **1、设置地址码**
    
    先为A、B、C每台主机设置一个8位编码作为其唯一标识，称为“地址码”（又叫码片序列）
    
    > 其中，需满足两两主机的码片序列互相做规格化内积（下文有介绍规格化内积），结果为0
    > 
    
    当一台主机要发送信息时，用其地址码表示“1”，其地址码的反码表示“0”。
    
    **2、消息传输过程**
    
    A、B将自己的信息用地址码加密后，将两份加密内容经过会波器做正交叠加。
    
    叠加后的数据通过信道传到C面前，再由分波器将其分解出一份来自A的数据内容+一份来自B的数据内容。如下图：
    
    ![示意图链接：[https://www.processon.com/diagraming/6527aa5cec6dd11d46772a1a](https://www.processon.com/diagraming/6527aa5cec6dd11d46772a1a)](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled%205.png)
    
    > 其中，正交叠加的过程如下：
    > 
    > 
    > 首先，我们定义电路上“1”为正电+1，“0”为负电-1，则有：
    > 
    > 1、发送端将A、B要发送的1bit数据用地址码&地址码反码表示，其中用地址码&地址码反码表示的两个数据中的0/1用电平的+1/-1表示
    > 
    > 2、对两个用地址码加密得到的电平数据做线性相加得到结果P
    > 
    
    > 其中，分波器的过程如下：
    > 
    > 
    > 其过程叫做“将结果P与A、B的地址码分别作规格化内积”，具体过程为：
    > 
    > 1、将结果P按位乘以某发送源的地址码，得到一个结果，除法规则如下：
    > 
    > ![Untitled](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled%206.png)
    > 
    > 2、将结果的所有电平相加得到总电平，除以地址码的长度，得到的+1/-1就对应了发送端的源数据”1“/”0”
    > 
    
    <aside>
    💡 总结：相乘，相加，再除以8
    【示例】
    
    - 示例如下：
      
        设A、B的序列码分别为00011011、00101110。在同一时间，有A向C发送“1”，B向C发送“0”，求此时的码分多路复用过程。
        
        解：
        
        - 发送端：
          
            A向C发送“1”，用序列码表示为：(-1,-1,-1,+1,+1,-1,+1,+1)
            
            B向C发送“0”，用序列码的反码表示为：(+1,+1,-1,+1,-1,-1,-1,+1)
            
            两个电平数据做线性相加得：P=(0,0,-2,+2,0,-2,0,+2)，将该结果P传入信道
            
        - 接收端：
          
            先做P对A序列码的规格化内积：
            
            相乘：(0,0,-2,+2,0,-2,0,+2)*(-1,-1,-1,+1,+1,-1,+1,+1)=(0,0,2,2,0,2,0,2)
            
            总电平：2+2+2+2=8
            
            除以序列码长度：8÷8=+1，所以A的原始数据为“1”
            
            再做P对B序列码的规格化内积：
            
            相乘：(0,0,-2,+2,0,-2,0,+2)*(-1,-1,+1,-1,+1,+1,+1,-1)=(0,0,-2,-2,0,-2,0,-2)
            
            总电平：(-2)+(-2)+(-2)+(-2)=-8
            
            除以序列码长度：(-8)÷8=-1，所以A的原始数据为“0”
            
    
    【限制】
    
    并不是所有的码片序列的主机之间都可以做多路复用，需要满足：两个主机的码片序列互相做规格化内积，结果为0
    

# 三、动态划分信道

有如下几种具体方案：

- 1、**ALOHA协议**
  
    【定义】
    
    如图：
    
    ![Untitled](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled%207.png)
    
    其中：
    
    - 发送时：随时想法就发
    - 识别冲突：接收方识别到这帧信息发生了出错，然后直接丢弃该帧并且不给发送方回复，发送方等待回复超时，就会自动意识到发生了冲突
    - 冲突处理：进行“随机重发”，即：随机等待一段时间，然后重发
    
    【特点】
    
    纯ALOHA因为极容易发生冲突，而且帧越大越容易冲突导致重传，所以效率很低，没有实际使用。
    
- 2、****时隙ALOHA协议****
  
    【定义】
    
    引入**“时隙”思想**：
    
    把时间轴分成若干个相同大小的时间片，每个时间片叫做“一个时隙”
    
    在进行“随机重发”时，把原先的“随机等待一段时间”改为“随机等待n个时隙的时间”
    
    【特点】
    
    “时隙”思想可以有效降低冲突发生的可能性
    
    下文中的所有动态信道划分协议所使用的随机等待都是基于“时隙”思想的随即等待
    
- 3、**CSMA协议（!!!）**
  
    【定义】
    
    引入**“监听”**思想：
    
    发送信息前监听一下信道是否被占用，若信道闲，发送；信道忙，推迟。信息先听后发。
    
    > 可以通过观测信道的电压摆动性实现监听，如果信道有在被占用，那么信道电压的摆动值会变大超过某个阈值
    > 
    
    设置了关于监听结果的三种应对方案：
    
    - **1-坚持**：
      
        【定义】
        
        若信道闲，则直接发送数据
        
        若信道忙，则继续监听
        
        若信道上发生冲突，则等待随机时隙，再监听
        
        > “1”的意思就是若信道闲则100%直接发送数据
        > 
        
        【特点】
        
        可能会发生一旦信道空闲大家就一拥而上造成“塞车”，人们提出了下文的两种方案作为改进
        
    - **非坚持：**
      
        【定义】
        
        若信道忙，则等待随机时隙，再监听
        
        【特点】
        
        防止了信道一旦空闲大家就一拥而上照成“塞车”，但其时间延迟比下文的p-坚持要大一些
        
    - **p-坚持：**
      
        【定义】
        
        若信道闲，则有p概率发送数据
        
        【特点】
        
        防止了信道一旦空闲大家就一拥而上照成“塞车”，同时其时间延迟更小，是主流方案！
        
    
- 4、**CSMA-CD协议（!!!）**
  
    **【定义】**
    
    CSMA的缺陷在于，如果发生了冲突，还是会继续傻傻的把那一帧数据传完，对此我们做了改进，提出“边发边检测“（CD）思想：
    
    说白就是边传边观测信道，如果观测到冲突，就直接停发并等待随机时间再重发
    
    > 该协议被应用于以太网（有线局域网）
    > 
    
    **【求发送端检测到碰撞的时延】**
    
    碰撞发生的过程如下：
    
    ![Untitled](%E4%BB%8B%E8%B4%A8%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%201eda4a3baf0d4185925ed03bb68b24c5/Untitled%208.png)
    
    从A端向B端发射一段信息，信息在传输的中途遇到碰撞产生出错，出错的信息继续传输达到B端，B端检测到出错并且返回一个错误回馈信息给到A
    
    设信息从一端到另一端的时间为“传播时延”，记为τ。
    
    而发送端从发送包到检测到碰撞的时间，正好是一个来回，记为一个“冲突窗口”，为2τ。所以只要在2τ的时间内，发送端没有收到错误回馈，就证明发射是成功的。
    
    **【最小帧长】**
    
    我们设发送端发完一帧数据所需时长为x，则显然应在x>2τ下才能使得“边发边检测“的思想有意义。
    
    按照这点，我们规定，`最小帧长所对应的x应当=2τ`。根据早期互联网的硬件数据得到τ和f(x)，代入解得最小帧长为64B，这一数字便成为了规定沿用至今。
    
    **【若传输遇到冲突，需等待多久时长】**
    
    等待时间遵循截断二进制指数退避算法：
    
    传输遇到冲突后，需等待的时间=r*2τ
    
    > 其中：
    > 
    > 
    > r为整数，其值由式子`r∈[0,1,...,$2^k$-1]`决定
    > 
    
    式中k为重传次数，如果重传失败就重传次数加一，也就会等待更长时间再重传。
    
    重传的次数最多为16，若超过16，则向上层抛出错误。
    
- 5、**CSMA-CA协议（!!!）**
  
    **【定义】**
    
    因为碰撞检测需要通过信道的电压变化实现，而这在无线传输中难以实现，所以我们设计了一个专门用于无线传输的CSMA-CA协议其基于CSMA的“先听再发”思想。
    
    其中，它的监听是通过能量检测（检测功率）和载波检测（接收到信号后和一个伪随机码进行一个运算）二者的混合检测方式实现。
    
    该协议应用于WLAN（无线局域网）。
    
    **【RTS/CTS协议】**
    
    为了应对“隐蔽站”问题，引入RTS/CTS协议，其能保证不会发生因为“节点A向节点B发信息时节点B也在向节点A发信息”而导致的冲突，内容如下：
    
    某节点准备发送数据前，会先发送一个短的RTS帧给接收方，表明它即将发送数据。该帧包含了发送数据的设备的地址和数据的长度等信息。
    
    如果接收方空闲，则其接收了RTS帧后会返回一个CTS帧给源设备，表示它已经准备好接收数据。该帧包含了源设备的地址，以及目标设备的准备接收数据的时间，它将在这个准备接收数据的时间内不会再使用信道做发送行为以避免冲突。
    
    发送端收到CTS帧后，在接收方给定的时间内发完它的包；若发送端超时未接收到CTS帧，则等待二进制指数退避算法等待r*2τ时间重发，直到成功。
    
    > 其局限在于，如果A向B发送信息时，C正好也在向B发信息，此时发生的冲突无法被RTS/CTS协议所避免
    > 

# 四、令牌轮询

【定义】

这是一种全新的介质访问控制思想：

“大哥”通过令牌轮询的方式，挨个问各个节点谁要发信息并全权规划信息发送顺序。

这可以使得每次信息的发送既占满信道又100%避免了冲突，但缺点是令牌轮询过程本身会导致额外的开销。

【内容】

一个设备作为“主节点”，其他设备作为“从属节点”。主节点将一张“令牌”（token）以固定的顺序轮流分配给各从属节点。

节点获得令牌后，如果有信息要发送，则将令牌携带上一帧内容后，将令牌归还主节点。主节点将携带一帧内容的令牌进行后续的轮询，直到携带一帧内容的令牌来到接收方处。

主节点分配令牌时遵循的是固定顺序，如A→B→C→A→B→C→...这种顺序就构成了一个逻辑上的“环”，所以令牌传递协议也叫“令牌环网协议”。

> 其中，令牌是一种特殊格式的MAC控制帧
>