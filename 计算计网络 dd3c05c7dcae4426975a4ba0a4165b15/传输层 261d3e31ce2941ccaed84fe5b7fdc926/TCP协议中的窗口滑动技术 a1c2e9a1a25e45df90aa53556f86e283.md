# TCP协议中的窗口滑动技术

# 窗口滑动技术

**【定义】**

为了最大效率地利用信道，应允许发送方在不等待接收方确认所有数据的情况下发送多个数据包

但这同时又产生了一个问题：如果此时发送方的数据加工发送速率速率大于接收方程序处理数据的速率，就会出现大量丢包的情况而影响效率

所以我们设计了窗口滑动技术：

窗口是发送方在不等待确认时能够发送的数据量的上限，通过调节窗口大小可以使发送方和接收方的速率实时地保持平衡

这种设计还顺便实现了拥塞控制：在突发事件导致拥塞时，也可以通过调整窗口大小实现拥塞控制。

**【基本实现】**

发送方维护一个发送窗口，其框注所有已发送但未被确认的数据。接收方维护一个接收窗口，其框柱所有已接收但未做排序检查的数据。

具体实现过程如下：

**1、协定窗口大小：**

在TCP连接建立阶段，双方协商初始的发送窗口大小（通常由接收方提出）

该协商通常是通过TCP的三次握手过程中的“选项”字段来进行的。

**2、数据发送：**

发送方发送一个窗口大小范围内的数据段，并将这些数据标记为“已发送但未确认”。

**3、接收方接收+确认：**

接收方接收并处理其接收窗口大小的数据，并发送确认（ACK）通知发送方已经成功接收到数据。

接收方根据其处理能力动态调整接收窗口大小，而接收窗口的大小可以被其ACK报文中的“确认号”字段间接体现。

4、**窗口滑动：** 

当发送方收到确认后，窗口向前滑动。这表示已经成功接收的数据不再占用发送方的窗口空间，为新的数据腾出位置。

同时，发送方根据接收方的“确认号”字段判断此时接收窗口大小，并以此动态调整发送窗口大小。

**【特殊的两个机制】**

TCP协议中还设置了以下的两个特殊机制：

- **快速重传/快速恢复：** 
如果发送方连续收到相同的确认，说明发生突发拥塞导致丢包。
    
    这种情况下，发送方会执行快速重传：并直接重传丢失的数据包，而无需等待超时。
    
    同时，发送方进入快速恢复状态，其将发送窗口的大小被设置为之前的一半，而后线性增长发送窗口大小，直到其认为与接收窗口大小达到协调。
    
- **慢启动机制：**
    
    在TCP连接初建立时，发送方会采用慢启动算法。
    
    初始时，发送方的发送窗口大小被设置为一个很小的值。而后其以指数速度不断扩大，直到接收方提醒其进入了慢启动阈值，此时其扩大速度变为谨慎的线性，直到达到一个其认为与接收速率相匹配的速度大小。
    
    其设计意义如下：
    
    - 之所以要从一个很小的值开始扩大，是因为TCP连接建立时，发送方不确定当前发送方的消息处理效率是多少
    - 之所以前期先以指数速度不断扩大，是为了减少启动时间
    - 之所以后期放慢扩大速度，是因为此时已接近窗口阈值，再快速扩大易导致拥堵